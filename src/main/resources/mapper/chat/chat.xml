<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.self_board_project.chat.mapper.ChatMapper">
    <sql id="selectQuery">
        SELECT t1.id,
               t1.room_id,
               t1.from_id,
               t1.to_id,
               t1.content,
               t1.read_check,
               t1.create_date
        FROM chat t1
    </sql>
    <select id="countChat" resultType="com.example.self_board_project.chat.vo.Chat">
        /** countChat **/
        select SUM(if(t1.field = 'relationship' and t1.read_yn = 'N', 1, 0)) relationshipCount,
               SUM(if(t1.field = 'evaluation' and t1.read_yn = 'N', 1, 0))   evaluationCount,
               SUM(if(t1.read_yn = 'N', 1, 0))                               totalNCount,
               count(1)                                                      totalCount
        from chat t1
        WHERE t1.user_id = #{userId}
    </select>
    <select id="selectChatList" resultType="com.example.self_board_project.chat.vo.Chat">
        /** selectChatList **/
        <include refid="selectQuery"/>
        <where>
            <if test="roomId != null and roomId != ''">
                AND t1.`room_id` = #{roomId}
            </if>
<!--            <if test="chatStaffId != null and chatStaffId != ''">-->
<!--                AND t1.`chat_staff_id` = #{chatStaffId}-->
<!--            </if>-->
        </where>
    </select>

    <select id="selectChat" resultType="com.example.self_board_project.chat.vo.Chat">
        <include refid="selectQuery"/>
        <where>
            <if test="roomId != null and roomId != ''">
                AND t1.`room_id` = #{roomId}
            </if>
        </where>
    </select>
    <insert id="insertChat" useGeneratedKeys="true" keyProperty="id">
        /** insertChat **/
        INSERT INTO `chat`( room_id
                                  , from_id
                                  , to_id
                                  , read_check
                                  , content
                                  , create_date)

        VALUES ( #{roomId}
               , #{fromId}
               , #{toId}
               , #{readCheck}
               , #{content}
               , now())
    </insert>

    <update id="updateChat">
        /** updateChat **/
        update `chat`
        set session_id = #{sessionId},
            session = #{session}
        WHERE id = #{Id}
<!--        <if test="field != null and field != ''">-->
<!--            AND field = #{field}-->
<!--        </if>-->
    </update>


</mapper>