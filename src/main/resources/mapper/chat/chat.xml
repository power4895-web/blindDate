<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.self_board_project.chat.mapper.ChatMapper">
    <sql id="selectQuery">
        SELECT t1.id,
               t1.room_id,
               t1.from_id,
               t1.to_id,
               t1.content,
               t1.read_yn,
               t1.create_date
        FROM chat t1
    </sql>
    <select id="countChat" resultType="int">
        /** countChat **/
        select count(*)
        from chat t1
        <where>
            <if test="toId != null and toId != ''">
                AND t1.`to_id` = #{toId}
            </if>
            <if test="fromId != null and fromId != ''">
                AND t1.`from_id` = #{fromId}
            </if>
            <if test="roomId != null and roomId != ''">
                AND t1.`room_id` = #{roomId}
            </if>
            <if test="readYn != null and readYn != ''">
                AND t1.`read_yn` = #{readYn}
            </if>
        </where>
    </select>
    <select id="selectChatList" resultType="com.example.self_board_project.chat.vo.Chat">
        /** selectChatList **/
        <include refid="selectQuery"/>
        <where>
            <if test="roomId != null and roomId != ''">
                AND t1.`room_id` = #{roomId}
            </if>
<!--            <if test="chatStaffId != null and chatStaffId != ''">-->
<!--                AND t1.`chat_staff_id` = #{chatStaffId}-->
<!--            </if>-->
        </where>
    </select>

    <select id="selectChat" resultType="com.example.self_board_project.chat.vo.Chat">
        <include refid="selectQuery"/>
        <where>
            <if test="roomId != null and roomId != ''">
                AND t1.`room_id` = #{roomId}
            </if>
        </where>
    </select>
    <select id="selectLastChat" resultType="com.example.self_board_project.chat.vo.Chat">
        select MAX(t1.id),
               t1.room_id,
               t1.from_id,
               t1.to_id,
               t1.content,
               t1.read_yn,
               t1.create_date
        from chat t1
        where room_id = #{roomId};
    </select>
    <insert id="insertChat" useGeneratedKeys="true" keyProperty="id">
        /** insertChat **/
        INSERT INTO `chat`( room_id
                                  , from_id
                                  , to_id
                                  , content
                                  , create_date)

        VALUES ( #{roomId}
               , #{fromId}
               , #{toId}
               , #{content}
               , now())
    </insert>

    <update id="updateChat">
        /** updateChat **/
        update `chat` t1
        set read_yn = "Y"
         <where>
              <if test="roomId != null and roomId != ''">
                  AND t1.`room_id` = #{roomId}
              </if>
              <if test="toId != null and toId != ''">
                  AND t1.`to_id` = #{toId}
              </if>
              <if test="fromId != null and fromId != ''">
                  AND t1.`from_id` = #{fromId}
              </if>
         </where>

    </update>


</mapper>