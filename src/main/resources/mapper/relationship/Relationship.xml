<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.self_board_project.relationship.mapper.RelationshipMapper">
<!--    type이 send면, 내가 보낸것이기 때문에 where에서 id조건은 로그인한 아이디이고, 보낸 사람들의 정볼르 가져와야 하기 때문에, file정보와, join은 getId로-->
<!--    수정: type을 안넣으면 널포인트 익셉션 떠서, 따로 쿼리를 만듬-->
<!--    정리: -->
<!--    내가 친구해요를 보낸 사람들의 정보를 받고 싶을 때 selectSand-->
<!--    나에게 친구해요를 보낸 사람들의 정보를 받고 싶을 때-->
<!--    그냥 select는 내가 보냈는지, 받았는지에 대한 여부정보 확인-->
    <sql id="selectQuery">
        SELECT
            t1.id,
            t1.send_id,
            t1.get_id,
            t1.accept_check,
            t1.create_date
        FROM relationship t1
    </sql>
    <select id="selectRelationshipList" resultType="com.example.self_board_project.relationship.vo.Relationship">
        /** selectRelationshipList **/
        <include refid="selectQuery"/>
        <where>
            <if test="sendId != null and sendId != ''">
                AND t1.`send_id` = #{sendId}
            </if>

            <if test="getId != null and getId != ''">
                AND t1.`get_id` = #{getId}
            </if>
<!--            <if test="acceptCheck != null and acceptCheck != ''">-->
<!--                AND (send_id = 1 and accept_check = 'Y') or (get_id = 1 and accept_check = 'Y')-->
<!--            </if>-->
        </where>
    </select>
    <select id="selectAcceptIsYList" resultType="com.example.self_board_project.relationship.vo.Relationship">
        /** selectAcceptIsYList **/
        SELECT
            t1.id,
            t1.send_id,
            t1.get_id,
            t1.accept_check,
            t1.create_date,
            t2.id,
            t2.nickname,
            (select concat(filepath, image_name) from file t3 where t2.id = t3.ref_id and t3.flag = 'S' AND boss_type = "Y") img_url
        FROM relationship t1
        join `user` t2 on t1.send_id = t2.id
        <where>
            accept_check = 'Y' and get_id = #{getId}
        </where>
    </select>


<!--    내가 친구해요 보낸 회원들의 정보-->
    <select id="selectSendRelationshipList" resultType="com.example.self_board_project.relationship.vo.Relationship">
        /** selectSendRelationshipList **/
        SELECT
            t1.id,
            t1.send_id,
            t1.get_id,
            t1.accept_check,
            t1.create_date,
            t2.id,
            t2.real_name,
            t2.nickname,
            t2.age,
            t2.gender,
            t2.email,
            t2.introduce,
            t2.phone_number,
            t2.address_doro,
            t2.address_detail,
            t2.postal_code,
            t2.job,
            t2.purpose,
            t2.smoking_yn,
            t2.drinking_type,
            t2.religion_type,
            t2.pet_type,
            t2.hobby,
            t2.ideal_type,
            t2.mbti,
            t2.height,
            t2.academic,
            t2.body_type,
            t2.personality,
            t2.workplace,
            (select concat(filepath, image_name) from file where ref_id = t1.get_id and boss_type ="Y" AND flag = "S")as imgUrl
        FROM relationship t1
        join user t2 on t1.get_id = t2.id
        <where>
            <if test="sendId != null and sendId != ''">
                AND t1.`send_id` = #{sendId}
            </if>

            <if test="getId != null and getId != ''">
                AND t1.`get_id` = #{getId}
            </if>
        </where>
    </select>
    <!--    나에게 친구해욜르 보낸 회원들의 정보-->
    <select id="selectGetRelationshipList" resultType="com.example.self_board_project.relationship.vo.Relationship">
        /** selectGetRelationshipList **/
        SELECT
            t1.id,
            t1.send_id,
            t1.get_id,
            t1.accept_check,
            t1.create_date,
            t2.id,
            t2.real_name,
            t2.nickname,
            t2.age,
            t2.gender,
            t2.email,
            t2.introduce,
            t2.phone_number,
            t2.address_doro,
            t2.address_detail,
            t2.postal_code,
            t2.job,
            t2.purpose,
            t2.smoking_yn,
            t2.drinking_type,
            t2.religion_type,
            t2.pet_type,
            t2.hobby,
            t2.ideal_type,
            t2.mbti,
            t2.height,
            t2.academic,
            t2.body_type,
            t2.personality,
            t2.workplace,
            (select concat(filepath, image_name) from file where ref_id = t1.send_id and boss_type ="Y" AND flag = "S")as imgUrl
        FROM relationship t1
        join user t2 on t1.send_id = t2.id
        <where>
            <if test="sendId != null and sendId != ''">
                AND t1.`send_id` = #{sendId}
            </if>

            <if test="getId != null and getId != ''">
                AND t1.`get_id` = #{getId}
            </if>
        </where>
    </select>

    <select id="selectRelationship" resultType="com.example.self_board_project.relationship.vo.Relationship">
        <include refid="selectQuery"/>
        <where>
            <if test="sendId != null and sendId != ''">
                AND t1.`send_id` = #{sendId}
            </if>

            <if test="getId != null and getId != ''">
                AND t1.`get_id` = #{getId}
            </if>
        </where>
    </select>
    <select id="selectSendRelationship" resultType="com.example.self_board_project.relationship.vo.Relationship">
        /** selectSendRelationship **/
        SELECT
            t1.id,
            t1.send_id,
            t1.get_id,
            t1.accept_check,
            t1.create_date,
            t2.id,
            t2.real_name,
            t2.nickname,
            t2.age,
            t2.gender,
            t2.email,
            t2.introduce,
            t2.phone_number,
            t2.address_doro,
            t2.address_detail,
            t2.postal_code,
            t2.job,
            t2.purpose,
            t2.smoking_yn,
            t2.drinking_type,
            t2.religion_type,
            t2.pet_type,
            t2.hobby,
            t2.ideal_type,
            t2.mbti,
            t2.height,
            t2.academic,
            t2.body_type,
            t2.personality,
            t2.workplace,
            (select concat(filepath, image_name) from file where ref_id = t1.get_id and boss_type ="Y" AND flag = "S")as imgUrl
        FROM relationship t1
        join user t2 on t1.send_id = t2.id
        <where>
            <if test="sendId != null and sendId != ''">
                AND t1.`send_id` = #{sendId}
            </if>

            <if test="getId != null and getId != ''">
                AND t1.`get_id` = #{getId}
            </if>
        </where>
    </select>
    <select id="selectGetRelationship" resultType="com.example.self_board_project.relationship.vo.Relationship">
        /** selectGetRelationship **/
        SELECT
            t1.id,
            t1.send_id,
            t1.get_id,
            t1.accept_check,
            t1.create_date,
            t2.id,
            t2.real_name,
            t2.nickname,
            t2.age,
            t2.gender,
            t2.email,
            t2.introduce,
            t2.phone_number,
            t2.address_doro,
            t2.address_detail,
            t2.postal_code,
            t2.job,
            t2.purpose,
            t2.smoking_yn,
            t2.drinking_type,
            t2.religion_type,
            t2.pet_type,
            t2.hobby,
            t2.ideal_type,
            t2.mbti,
            t2.height,
            t2.academic,
            t2.body_type,
            t2.personality,
            t2.workplace,
            (select concat(filepath, image_name) from file where ref_id = t1.send_id and boss_type ="Y" AND flag = "S")as imgUrl
        FROM relationship t1
        join user t2 on t1.send_id = t2.id
        <where>
            <if test="sendId != null and sendId != ''">
                AND t1.`send_id` = #{sendId}
            </if>

            <if test="getId != null and getId != ''">
                AND t1.`get_id` = #{getId}
            </if>
        </where>
    </select>
    <insert id="insertRelationship" useGeneratedKeys="true" keyProperty="id">
        /** insertRelationship **/
        INSERT INTO `relationship`( send_id
                                  , get_id
                                  , accept_check
                                  , create_date)

        VALUES ( #{sendId}
               , #{getId}
               , #{acceptCheck}
               , now())
    </insert>
    <update id="allowRelationship">
        /** allowRelationship **/
        UPDATE `relationship`
        SET accept_check = 'Y',
            update_date = now()
        WHERE id = #{id}
    </update>


</mapper>