<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.self_board_project.relationship.mapper.RelationshipMapper">
<!--    type이 send면, 내가 보낸것이기 때문에 where에서 id조건은 로그인한 아이디이고, 보낸 사람들의 정볼르 가져와야 하기 때문에, file정보와, join은 getId로-->

    <sql id="selectQuery">
        SELECT t1.id,
        t1.send_id,
        t1.get_id,
        t1.accept_check,
        t1.create_date,
        t2.id,
        t2.real_name,
        t2.nickname,
        t2.age,
        t2.gender,
        t2.email,
        t2.introduce,
        t2.phone_number,
        t2.address_doro,
        t2.address_detail,
        t2.postal_code,
        t2.job,
        t2.purpose,
        if(${type == 'send'} ,(select concat(filepath, image_name) from file where ref_id = t1.get_id and boss_type =
        "Y" AND flag = "S")
        ,(select concat(filepath, image_name) from file where ref_id = t1.send_id and boss_type = "Y" AND flag = "S"))
        as imgUrl
        FROM relationship t1
        <if test='type.equals("send")'>
            join user t2 on t1.get_id = t2.id
        </if>
        <if test='type.equals("get")'>
            join user t2 on t1.send_id = t2.id
        </if>
    </sql>
    <select id="selectRelationshipList" resultType="com.example.self_board_project.relationship.vo.Relationship">
        <include refid="selectQuery"/>
        <where>
            <if test="sendId != null and sendId != ''">
                AND t1.`send_id` = #{sendId}
            </if>

            <if test="getId != null and getId != ''">
                AND t1.`get_id` = #{getId}
            </if>
        </where>
    </select>

    <select id="selectRelationship" resultType="com.example.self_board_project.relationship.vo.Relationship">
        <include refid="selectQuery"/>
        <where>
            <if test="sendId != null and sendId != ''">
                AND t1.`send_id` = #{sendId}
            </if>

            <if test="getId != null and getId != ''">
                AND t1.`get_id` = #{getId}
            </if>
        </where>

    </select>
    <insert id="insertRelationship" useGeneratedKeys="true" keyProperty="id">

        INSERT INTO `relationship`( send_id
                                  , get_id
                                  , create_date)

        VALUES ( #{sendId}
               , #{getId}
               , now())
    </insert>
    <!--    <insert id="insertRelationship" useGeneratedKeys="true" keyProperty="id">-->
    <!--        insert-->
    <!--        into relationship (send_id,-->
    <!--                           get_id,-->
    <!--                           create_date)-->
    <!--        values (#{sendId},-->
    <!--                #{getId},-->
    <!--                NOW())-->
    <!--    </insert>-->
    <!--    <update id="">-->

    <!--    </update>-->

    <!--    <delete id="">-->

    <!--    </delete>-->


</mapper>