<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--user정보 가져올 땐 flag값 없이 그냥 가져오면 대표이미지로 M값 가져옴
근데 S나 다른 Xs 가져오고 싶을 땐 flga값을 넣어주면 대표미이지로 된 다른 flag값 가져온다-->
<mapper namespace="com.example.self_board_project.user.mapper.UserMapper">
    <sql id="selectQuery">
        SELECT t1.id,
        t1.login_id,
        t1.password,
        t1.nickname,
        t1.real_name,
        t1.age,
        t1.gender,
        t1.email,
        t1.phone_number,
        t1.address_doro,
        t1.address_jibun,
        t1.latitude,
        t1.longitude,
        t1.address_detail,
        t1.postal_code,
        t1.grade_score,
        t1.grade_code,
        t1.job,
        t1.workplace,
        t1.purpose,
        t1.introduce,
        t1.today_profile_id,
        t1.delete_ids,
        t1.smoking_yn,
        t1.drinking_type,
        t1.religion_type,
        t1.pet_type,
        t1.hobby,
        t1.ideal_type,
        t1.mbti,
        t1.height,
        t1.academic,
        t1.body_type,
        t1.personality,
        t1.create_date,
        t1.update_date,
        t1.update_id,
        t1.role,
        t1.provider
        <if test="flag != null and flag != ''">
            , concat(t2.filepath, t2.image_name) img_url
        </if>
        FROM user t1
        <if test="flag != null and flag != ''">
            join file t2 on t1.id = t2.ref_id and flag = #{flag} AND boss_type = 'Y'
        </if>
<!--        <if test="flag == null ">-->
<!--            join file t2 on t1.id = t2.ref_id-->
<!--        </if>-->
<!--        <if test="flag == null ">-->
<!--            join file t2 on t1.id = t2.ref_id and flag = 'M' AND boss_type = "Y"-->
<!--        </if>-->
    </sql>


    <select id="selectUserList" resultType="com.example.self_board_project.user.vo.User">
        /** selectUserList **/
        <include refid="selectQuery"/>
        <where>
            <if test="gender != null and gender != ''">
                AND gender = #{gender}
            </if>
            <if test="ids != null and ids.size > 0">
                AND t1.id NOT IN
                <foreach collection="ids" item="id" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
            <if test='order.equals("rand")'>
                order by rand()
            </if>
            <if test='!order.equals("rand")'>
                order by #{order}
            </if>
            <if test="limit != null and limit != ''">
                limit #{limit}
            </if>
        </where>
    </select>

    <select id="selectUserRandomList" resultType="com.example.self_board_project.user.vo.User">
        /** selectUserRandomList **/
        <include refid="selectQuery"/>
        <where>
            <if test="gender != null and gender != ''">
                AND gender = #{gender}
            </if>
            <if test="ids != null and ids.size > 0">
                AND t1.id NOT IN
                <foreach collection="ids" item="id" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
            order by rand()
            <if test="limit != null and limit != ''">
                limit #{limit}
            </if>
        </where>
    </select>

    <select id="selectUser" resultType="com.example.self_board_project.user.vo.User">
        /** selectUser **/
        <include refid="selectQuery"/>
        <where>
            <if test="id != null and id != ''">
                AND t1.id = #{id}
            </if>
            <if test="nickname != null and nickname != ''">
                AND t1.nickname = #{nickname}
            </if>
            <if test="email != null and email != ''">
                AND t1.email = #{email}
            </if>
            <if test="realName != null and realName != ''">
                AND t1.real_name = #{realName}
            </if>
        </where>
    </select>

    <insert id="insertUser" useGeneratedKeys="true" keyProperty="id">
        /** insertUser **/
        INSERT INTO `user`( login_id
                          , password
                          , real_name
                          , nickname
                          , age
                          , gender
                          , email
                          , phone_number
                          , address_doro
                          , address_jibun
                          , latitude
                          , longitude
                          , address_detail
                          , postal_code
                          , job
                          , workplace
                          , purpose
                          , introduce
                          , smoking_yn
                          , drinking_type
                          , religion_type
                          , pet_type
                          , hobby
                          , ideal_type
                          , mbti
                          , height
                          , academic
                          , body_type
                          , personality
                          , provider
                          , provider_id
                          , username
                          , role
                          , today_profile_id
                          , create_date)

        VALUES ( #{loginId}
               , #{password}
               , #{realName}
               , #{nickname}
               , #{age}
               , #{gender}
               , #{email}
               , #{phoneNumber}
               , #{addressDoro}
               , #{addressJibun}
               , #{latitude}
               , #{longitude}
               , #{addressDetail}
               , #{postalCode}
               , #{job}
               , #{workplace}
               , #{purpose}
               , #{introduce}
               , #{smokingYn}
               , #{drinkingType}
               , #{religionType}
               , #{petType}
               , #{hobby}
               , #{idealType}
               , #{mbti}
               , #{height}
               , #{academic}
               , #{bodyType}
               , #{personality}
               , #{provider}
               , #{providerId}
               , #{username}
               , #{role}
               , #{todayProfileId}
               , now())
    </insert>


    <update id="deleteUserIds">
        /** updateUser **/
        UPDATE user
        SET login_id= #{loginId},
            password= #{password},
            nickname= #{nickname},
            real_name= #{realName},
            age= #{age},
            gender= #{gender},
            email= #{email},
            phone_number= #{phoneNumber},
            introduce= #{introduce},
            address_doro = #{addressDoro},
            address_jibun = #{addressJibun},
            latitude = #{latitude},
            longitude = #{longitude},
            address_detail = #{addressDetail},
            postal_code = #{postalCode},
            job = #{job},
            purpose = #{purpose},
            introduce = #{introduce},
            smoking_yn = #{smokingYn},
            drinking_type = #{drinkingType},
            religion_type = #{religionType},
            pet_type = #{petType},
            hobby = #{hobby},
            ideal_type = #{idealType},
            mbti = #{mbti},
            height = #{height},
            academic = #{academic},
            body_type = #{bodyType},
            personality = #{personality},
            today_profile_id= #{todayProfileId},
            delete_ids= #{deleteIds},
            update_date= now()
        WHERE id = #{id}
    </update>

    <update id="updateTodayProfileId">
        /** updateTodayProfileId **/
        UPDATE user
        SET today_profile_id = #{todayProfileId}
        WHERE id = #{id}
    </update>

</mapper>